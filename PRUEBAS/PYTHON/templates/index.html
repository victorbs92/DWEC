<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="0">
    <meta http-equiv="Cache-Control" content="no-cache, mustrevalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <title>Carrera de algoritmos</title>
    <link rel="stylesheet" href="../static/styles.css">
    <!-- Load plotly.js into the DOM -->
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <!-- Load JQuery and AJAX -->
    <script src=" https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js "> </script>
</head>

<body>
    <nav>
        <ul class="activado">
            <li><a href="index.html">Principal</a></li>
            <li><a href="instrucciones.html">Instrucciones</a></li>
            <li><a href="informacion.html">Informacion</a></li>
        </ul>
    </nav>
    <div>
        <form method="POST" enctype="multipart/form-data">
            <h2 id='crono' class="border-gradient border-gradient-green">00:00</h2>
            <br>
            <h1>Calculo de rutas con algoritmos</h1>
            <br>
            <label for="minutosEjecucion">Introduce el tiempo de ejecución (minutos): </label>
            <input type="number" name="minutosEjecucion" id="minutosEjecucion" min="1">
            <br>
            <label for="archivo">Seleccione la matrix (CSV): </label>
            <input type="file" name="matriz" id="matriz" accept=".csv">
            <br><br>
            <p id="mensajeValidacion">Error en el archivo (QUITAR DESPUES DE PROBAR)</p>
            <button class="boton border-gradient border-gradient-green" name="botonComenzar" type="submit"
                value="COMENZAR" id="comenzar">Comenzar</button>
            <button name="botonTerminar" type="submit" value="TERMINAR" id="terminar"
                class="boton border-gradient border-gradient-green">Terminar</button>
            <br><br>
            <div id="resultados">
                <ul id="contenedor1" class="grid">
                    <li id="alg1" class="alg">
                        <h3>Algoritmo de Monte Carlo</h3>
                    </li>
                    <li id="gra1" class="gra"></li>
                    <li id="dis1" class="dis"></li>
                    <li id="ite1" class="ite"></li>
                    <li id="rut1" class="rut"></li>
                </ul>
                <ul id="contenedor2" class="grid">
                    <li id="alg2" class="alg">
                        <h3>Algoritmo de Fuerza Bruta</h3>
                    </li>
                    <li id="gra2" class="gra"></li>
                    <li id="dis2" class="dis"></li>
                    <li id="ite2" class="ite"></li>
                    <li id="rut2" class="rut"></li>
                </ul>
                <ul id="contenedor3" class="grid">
                    <li id="alg3" class="alg">
                        <h3>Algoritmo del Vecino mas Cercano</h3>
                    </li>
                    <li id="gra3" class="gra"></li>
                    <li id="dis3" class="dis"></li>
                    <li id="ite3" class="ite"></li>
                    <li id="rut3" class="rut"></li>
                </ul>
            </div>
            <br><br>
            <canvas id="q">
                <div id="campoOculto"></div>
        </form>
    </div>

    <script src="../static/fondo.js"></script>
    <script type=text/javascript> $SCRIPT_ROOT={{ request.script_root|tojson|safe }}; </script> <script>

        let ls = window.localStorage; //accede al localStorage

        window.addEventListener("load", reloj(this.event));

        let botonComenzar = document.getElementById("comenzar");
        botonComenzar.addEventListener("click", () => {
            let minutos = document.getElementById("minutosEjecucion");
            let ls = window.localStorage;
            ls.setItem('minutos', minutos.value);
            ls.setItem('mostrarDatos', "no");
        });

        let botonTerminar = document.getElementById("terminar");
        botonTerminar.addEventListener("click", () => {
            let ls = window.localStorage;
            ls.setItem('minutos', 0);
            ls.setItem('mostrarDatos', "si");
        });

        function reloj(e) {

            let ls = window.localStorage; //accede al localStorage
            let minutos = ls.getItem('minutos'); //guarda en una variable el valor de "time" del localStorage

            if (minutos !== null && minutos !== "0" && minutos !== 0) { //si minu es distinto de null y de 0
                let crono = document.getElementById("crono");

                // Set the date we're counting down to
                let countDownDate = new Date().getTime() + minutos * 1000 * 60;

                // Update the count down every 1 second
                let intervalo = setInterval(function () {

                    // Get today's date and time
                    let now = new Date().getTime();

                    // Find the distance between now and the count down date
                    let totalTime = countDownDate - now;

                    // Time calculations for days, hours, minutes and seconds
                    let days = Math.floor(totalTime / (1000 * 60 * 60 * 24));
                    let hours = Math.floor((totalTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    let minutes = Math.floor((totalTime % (1000 * 60 * 60)) / (1000 * 60));
                    let seconds = Math.floor((totalTime % (1000 * 60)) / 1000);

                    if (seconds % 2 == 0) {
                        mostrarResultados();
                    }

                    // Output the result in an element with id="crono"
                    crono.innerHTML = days + "d " + hours + "h " +
                        minutes + "m " + seconds + "s ";

                    // If the count down is over, write some text 
                    if (totalTime < 0) {
                        clearInterval(intervalo);
                        ls.setItem("minutos", 0);
                        ls.setItem('mostrarDatos', "si");
                        cerrarProcesosServidor();
                    }
                    
                }, 1000);

            } else if(ls.getItem('mostrarDatos') == "si"){
                //console.log("AQUI ENTRA")
                mostrarResultados();
            }

            function cerrarProcesosServidor(){
                let input = document.createElement("input");
                input.setAttribute("type", "hidden");
                input.setAttribute("name", "pararProcesos");
                input.setAttribute("value", "si");
                //append to form element that you want .
                document.getElementById("campoOculto").appendChild(input);
                document.forms[0].submit();
            }

            document.getElementById('matriz').addEventListener('change', validarCSV, false);
            function validarCSV(evt) {
                let mensajeValidacion = document.getElementById("mensajeValidacion");
                let file = evt.target.files[0];
                let reader = new FileReader();
                reader.onload = (e) => {
                    // Cuando el archivo se terminó de cargar
                    let lines = parseCSV(e.target.result);
                    let matrizCSV = reverseMatrix(lines);
                    if (matrizCSV === null) {
                        mensajeValidacion.innerHTML = "ERROR"
                    } else {
                        mensajeValidacion.innerHTML = "CSV VALIDO"
                        generarXY(matrizCSV);
                    }

                };
                // Leemos el contenido del archivo seleccionado
                reader.readAsBinaryString(file);
            }

            function parseCSV(text) {
                // Obtenemos las lineas del texto
                let lines = text.trim();
                lines = lines.replace(/\r/g, '').split('\n');

                return lines.map(line => {
                    // Por cada linea obtenemos los valores
                    let values = line.split(',');
                    return values;
                });
            }

            function reverseMatrix(matrix) {
                //console.log(matrix.length);
                //console.log(matrix);


                //let ls = window.localStorage; //accede al localStorage
                //matrizJson = JSON.stringify(matrix)
                //ls.setItem('matriz', matrizJson); 
                //let filas = sum(matrix);
                //console.log(filas);

                let numFilas = matrix.length;
                let output = [];
                let flag = false;
                let contElementosPorColumna = 0 //para comprobar que haya el mismo numero de filas que de columnas
                // Por cada fila
                matrix.forEach((values, row) => {
                    contElementosPorColumna = 0;
                    // Vemos los valores y su posicion
                    values.forEach((value, col) => {
                        contElementosPorColumna++;
                        if (value === "" || value === undefined || isNaN(value) || value < 0) {
                            flag = true;
                        }
                        // Si la posición aún no fue creada
                        if (output[col] === undefined) {
                            output[col] = [];
                        }
                        output[col][row] = value;
                    });
                    if (contElementosPorColumna !== numFilas) {
                        flag = true;
                    }
                });
                if (flag === true) {
                    return null
                } else {
                    return output;
                }
            }

            function generarXY(matrizCSV){
                let ls = window.localStorage; //accede al localStorage
                let arrayX = new Array();
                let arrayY = new Array();
                let ciudades = new Array();
                let suma=0;

                //console.log(matrizCSV);
                //console.log("::::::::::::::::::");
                for (i=0; i<matrizCSV.length; i++){
                    ciudades.push("C." + i);
                    suma = 0;  
                    for (j=0; j<matrizCSV[i].length; j++){  
                        aux = parseInt(matrizCSV[i][j].trim());
                        suma += aux;
                        if(i === 0){
                            arrayY[j] = 0;
                        }
                        arrayY[j] += Math.round( aux / (j+1));
                    }
                    arrayX.push(Math.round(suma * (i+1)));
                }
                arrayX.push(arrayX[0]);
                arrayY.push(arrayY[0]);

                //console.log("ASDFASFGASFASFDASF");

                let arrayXLS = JSON.stringify(arrayX);
                let arrayYLS = JSON.stringify(arrayY);
                let ciudadesLS = JSON.stringify(ciudades);
                ls.setItem('arrayXLS', arrayXLS);
                ls.setItem('arrayYLS', arrayYLS);
                ls.setItem('ciudadesLS', ciudadesLS);

            }

            //let resultado = document.getElementById("resultado");
            function mostrarResultados() {
                
                ls.setItem('mostrarDatos', 'no');
                    
                $.ajax({
                    url: "/static/FuerzaBrutaResultados.txt", 
                    dataType: "text",
                    success: function (data) {
                        //console.log(data)
                        let expresionRegular = /\s*=>\s*/;
                        let ciudades = data.split(expresionRegular);
                        ciudades.splice(0,1);
                        ciudades[ciudades.length-1] = ciudades[ciudades.length-1].slice(0, -3)
                        ciudades.unshift(ciudades[ciudades.length-1]);
                        ls = window.localStorage; //accede al localStorage
                        //let matrizLocalStorage = JSON.parse(ls.getItem("matriz"));
                        //console.log(matrizLocalStorage);
                        //console.log(ciudades)
                        mostrarGrafica(ciudades);
                        //se trabaja con matrizLocalStorage y ciudades
                        $("#rut2").text(data);
                    }
                });/*
                $.ajax({
                    url: "/static/MontecarloResultados.txt", 
                    dataType: "text",
                    success: function (data) {
                        console.log(data)
                        $("#resultado2").text(data);
                    }
                });*/

            }

            function mostrarGrafica(ruta){
                let arrayXLS = JSON.parse(ls.getItem('arrayXLS'));
                let arrayYLS = JSON.parse(ls.getItem('arrayYLS'));
                let ciudadesLS = JSON.parse(ls.getItem('ciudadesLS'));
                let arrayX = new Array();
                let arrayY = new Array();
                let ciudades = new Array();
                let aux = 0;
                for (i=0; i<ruta.length; i++){
                   aux = parseInt(ruta[i].substring(ruta[i].length - 2, ruta[i].length).trim());
                   arrayX.push(arrayXLS[aux]);
                   arrayY.push(arrayYLS[aux]);
                   ciudades.push(ciudadesLS[aux]);
                   //console.log(aux);
                }

                arrayX.push(arrayX[0]);
                arrayY.push(arrayY[0]);
                ciudades.push(ciudades[0]);
                       
                var trace = {
                   x: arrayX,
                   y: arrayY,
                   mode: "lines+markers+text",
                   type: "scatter",
                   text: ciudades
                 };
                 
                 var data = [trace];
                 /*
                 var layout = {
                   title: "Display the Edit Chart Link"
                 };
                 */
                 //Plotly.newPlot("gra2", data, layout);
                 Plotly.newPlot("gra2", data);
            }

        }
    </script>

</body>

</html>